# Pythonå¹¶å‘ç¼–ç¨‹ [undone]

>   **Pythonè§£é‡Šå™¨**ç”±äºè®¾è®¡æ—¶æœ‰GILå…¨å±€é”ï¼Œå¯¼è‡´äº†å¤šçº¿ç¨‹æ— æ³•åˆ©ç”¨å¤šæ ¸ã€‚å¤šçº¿ç¨‹çš„å¹¶å‘åœ¨Pythonä¸­å°±æ˜¯ä¸€ä¸ªç¾ä¸½çš„æ¢¦ã€‚ -- å»–é›ªå³°

## GILé” (Global Interpreter Lock)

<img src="https://cdn.jsdelivr.net/gh/ihatebeans/images@main/img/image-20210912140334271.png" style="zoom:33%;" />

Pythonçš„çº¿ç¨‹è™½ç„¶æ˜¯çœŸæ­£çš„çº¿ç¨‹ï¼Œä½†***è§£é‡Šå™¨***æ‰§è¡Œä»£ç æ—¶ï¼Œæœ‰ä¸€ä¸ªGILé”(*Global Interpreter Lock*)ï¼Œ**ä»»ä½•**Pythonçº¿ç¨‹æ‰§è¡Œå‰ï¼Œå¿…é¡»å…ˆè·å¾—GILé”ï¼Œç„¶åï¼Œæ¯æ‰§è¡Œ100æ¡å­—èŠ‚ç ï¼Œè§£é‡Šå™¨å°±è‡ªåŠ¨é‡Šæ”¾GILé”ï¼Œè®©åˆ«çš„çº¿ç¨‹æœ‰æœºä¼šæ‰§è¡Œã€‚è¿™ä¸ªGILå…¨å±€é”å®é™…ä¸ŠæŠŠæ‰€æœ‰çº¿ç¨‹çš„æ‰§è¡Œä»£ç éƒ½ç»™ä¸Šäº†é”ï¼Œæ‰€ä»¥ï¼Œå¤šçº¿ç¨‹åœ¨Pythonä¸­åªèƒ½äº¤æ›¿æ‰§è¡Œï¼Œå³ä½¿100ä¸ªçº¿ç¨‹è·‘åœ¨100æ ¸CPUä¸Šï¼Œä¹Ÿåªèƒ½ç”¨åˆ°1ä¸ªæ ¸ã€‚

æ‰€ä»¥ï¼ŒPython çš„çº¿ç¨‹æ›´é€‚ç”¨äºå¤„ç†**IOå¯†é›†å‹**çš„**é˜»å¡æ“ä½œ**ï¼ˆæ¯”å¦‚ç­‰å¾…I/Oã€ç­‰å¾…ä»æ•°æ®åº“è·å–æ•°æ®ç­‰ç­‰ï¼‰ï¼Œè€Œä¸æ˜¯éœ€è¦å¤šå¤„ç†å™¨å¹¶è¡Œçš„è®¡ç®—å¯†é›†å‹ä»»åŠ¡(å³:**CPUå¯†é›†å‹**)ã€‚

GILæ˜¯Pythonè§£é‡Šå™¨è®¾è®¡çš„å†å²é—ç•™é—®é¢˜ï¼Œé€šå¸¸æˆ‘ä»¬ç”¨çš„è§£é‡Šå™¨æ˜¯å®˜æ–¹å®ç°çš„CPythonï¼Œè¦çœŸæ­£åˆ©ç”¨å¤šæ ¸ï¼Œé™¤é**é‡å†™ä¸€ä¸ªä¸å¸¦GILçš„è§£é‡Šå™¨**ğŸ¤ª ã€‚

æ‰€ä»¥ï¼Œåœ¨Pythonä¸­ï¼Œå¯ä»¥ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œä½†ä¸è¦æŒ‡æœ›èƒ½æœ‰æ•ˆåˆ©ç”¨å¤šæ ¸ã€‚å¦‚æœä¸€å®šè¦é€šè¿‡å¤šçº¿ç¨‹åˆ©ç”¨å¤šæ ¸ï¼Œé‚£åªèƒ½é€šè¿‡Cæ‰©å±•æ¥å®ç°ï¼Œä¸è¿‡è¿™æ ·å°±å¤±å»äº†Pythonç®€å•æ˜“ç”¨çš„ç‰¹ç‚¹ã€‚

ä¸è¿‡ï¼Œä¹Ÿä¸ç”¨è¿‡äºæ‹…å¿ƒï¼ŒPythonè™½ç„¶ä¸èƒ½åˆ©ç”¨å¤šçº¿ç¨‹å®ç°å¤šæ ¸ä»»åŠ¡ï¼Œä½†å¯ä»¥é€šè¿‡**å¤šè¿›ç¨‹å®ç°å¤šæ ¸ä»»åŠ¡**ğŸ˜• ã€‚å¤šä¸ªPythonè¿›ç¨‹æœ‰å„è‡ªç‹¬ç«‹çš„GILé”ï¼Œäº’ä¸å½±å“ã€‚

**WHY**: pythonä½¿ç”¨å¼•ç”¨è®¡æ•°å™¨è¿›è¡Œç®¡ç†å¯¹è±¡, å¼•ç”¨æ•°ä¸º0é‡Šæ”¾å¯¹è±¡, ç®€åŒ–pythonå¯¹å…±äº«èµ„æºçš„ç®¡ç†.

**æ€»ç»“**: `GILé”`æ˜¯Pythonè§£é‡Šå™¨çš„"è®¾è®¡ç¼ºé™·",æ— æ³•å®ç°å¤šæ ¸ä»»åŠ¡, ä¸”çŸ­æœŸå†…æ”¹ä¸æ‰, ä½†æ˜¯å¯ä»¥é€šè¿‡**å¤šè¿›ç¨‹å®ç°å¤šæ ¸ä»»åŠ¡**.

## å¤šçº¿ç¨‹ä¸‹IOå¯†é›†å‹å’Œcpuå¯†é›†å‹å¯¹æ¯”æ€»ç»“

### 1. CPUå¯†é›†å‹(CPU-bound)

ä¸€ä¸ª**è®¡ç®—**ä¸ºä¸»çš„ç¨‹åºã€‚å¤šçº¿ç¨‹è·‘çš„æ—¶å€™ï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨èµ·æ‰€æœ‰çš„cpuæ ¸å¿ƒï¼Œæ¯”å¦‚è¯´4ä¸ªæ ¸å¿ƒçš„cpu,å¼€4ä¸ªçº¿ç¨‹çš„æ—¶å€™ï¼Œå¯ä»¥åŒæ—¶è·‘4ä¸ªçº¿ç¨‹çš„è¿ç®—ä»»åŠ¡ï¼Œæ­¤æ—¶æ˜¯æœ€å¤§æ•ˆç‡ã€‚
ä½†æ˜¯å¦‚æœçº¿ç¨‹è¿œè¿œè¶…å‡ºcpuæ ¸å¿ƒæ•°é‡åè€Œä¼šä½¿å¾—ä»»åŠ¡æ•ˆç‡ä¸‹é™ï¼Œå› ä¸ºé¢‘ç¹çš„åˆ‡æ¢çº¿ç¨‹ä¹Ÿæ˜¯è¦æ¶ˆè€—æ—¶é—´çš„ã€‚
å› æ­¤å¯¹äºcpuå¯†é›†å‹çš„ä»»åŠ¡æ¥è¯´ï¼Œ**çº¿ç¨‹æ•°ç­‰äºcpuæ•°**æ˜¯æœ€å¥½çš„äº†ã€‚

æ¯”å¦‚: å‹ç¼©è§£å‹ç¼©, åŠ å¯†è§£å¯†, æ­£åˆ™è¡¨è¾¾å¼æœç´¢ç­‰

### 2. IOå¯†é›†å‹(I/O-bound)

å¦‚æœæ˜¯ä¸€ä¸ª**ç£ç›˜æˆ–ç½‘ç»œ**ä¸ºä¸»çš„ç¨‹åºï¼ˆIOå¯†é›†å‹ï¼‰ã€‚ä¸€ä¸ªçº¿ç¨‹å¤„åœ¨**IOç­‰å¾…/é˜»å¡**çš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹è¿˜å¯ä»¥åœ¨CPUé‡Œé¢è·‘ï¼Œæœ‰æ—¶å€™CPUé—²ç€æ²¡äº‹å¹²ï¼Œæ‰€æœ‰çš„çº¿ç¨‹éƒ½åœ¨ç­‰ç€IOï¼Œè¿™æ—¶å€™ä»–ä»¬å°±æ˜¯åŒæ—¶çš„äº†ï¼Œè€Œå•çº¿ç¨‹çš„è¯æ­¤æ—¶è¿˜æ˜¯åœ¨ä¸€ä¸ªä¸€ä¸ªç­‰å¾…çš„ã€‚æˆ‘ä»¬éƒ½çŸ¥é“IOçš„é€Ÿåº¦æ¯”èµ·CPUæ¥æ˜¯æ…¢åˆ°ä»¤äººå‘æŒ‡çš„ã€‚æ‰€ä»¥å¼€å¤šçº¿ç¨‹ï¼Œæ¯”æ–¹è¯´å¤šçº¿ç¨‹ç½‘ç»œä¼ è¾“ï¼Œå¤šçº¿ç¨‹å¾€ä¸åŒçš„ç›®å½•å†™æ–‡ä»¶ï¼Œç­‰ç­‰ã€‚æ­¤æ—¶çº¿ç¨‹æ•°ç­‰äºIOä»»åŠ¡æ•°æ˜¯æœ€ä½³çš„ã€‚

æ¯”å¦‚: æ–‡ä»¶å¤„ç†, httpè¯·æ±‚, æ•°æ®åº“è¯»å†™ç­‰

## å¤šçº¿ç¨‹ç¼–ç¨‹

ä¼˜ç‚¹: 

- ç›¸æ¯”äºè¿›ç¨‹, æ›´è½»é‡, å ç”¨èµ„æºå°‘

ç¼ºç‚¹:

- ç›¸æ¯”è¿›ç¨‹: å¤šçº¿ç¨‹åªèƒ½å¹¶å‘æ‰§è¡Œ, ä¸èƒ½åˆ©ç”¨å¤šCPU (GIL)
- ç›¸æ¯”åç¨‹: å¯ç”¨æ•°ç›®æœ‰é™åˆ¶, å ç”¨å†…å­˜èµ„æº, æœ‰çº¿ç¨‹åˆ‡æ¢å¼€é”€

é€‚ç”¨äº:

- IOå¯†é›†å‹è®¡ç®—, åŒæ—¶è¿è¡Œçš„ä»»åŠ¡æ•°ç›®è¦æ±‚ä¸å¤š

### æ™®é€šå¤šçº¿ç¨‹ç¼–ç¨‹

ä½¿ç”¨`threading`æ¨¡å—åˆ›å»º`Thread`å®ä¾‹, ç„¶åè°ƒç”¨`start()`å¼€å§‹æ‰§è¡Œ

```python
import threading, time

def do_something(i):
    print(f"Start doing {i}")
    time.sleep(2)
    print(f"End doing {i}")
    return True

def main():
    threads = []
    for i in range(10):
        this_threading = threading.Thread(target=do_some_thing, args=(i, ))
        # è°ƒç”¨`start()`å¼€å§‹æ‰§è¡Œ
        this_threading.start()
        threads.append(this_threading)

    print("___ä¸»çº¿ç¨‹å¼€å§‹ğŸ”›___")

    # è°ƒç”¨`thread.join()`çš„ä½œç”¨æ˜¯ç¡®ä¿å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åæ‰èƒ½æ‰§è¡Œä¸‹ä¸€ä¸ªçº¿ç¨‹
    for thread in threads:
        thread.join()

    print("___ä¸»çº¿ç¨‹ç»“æŸğŸ”š___")

if __name__ == '__main__':
    main()
```

### åŠ é”ä¿è¯çº¿ç¨‹å®‰å…¨

>   "å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ`lock.acquire()`æ—¶ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æˆåŠŸåœ°è·å–é”ï¼Œç„¶åç»§ç»­æ‰§è¡Œä»£ç ï¼Œå…¶ä»–çº¿ç¨‹å°±ç»§ç»­ç­‰å¾…ç›´åˆ°è·å¾—é”ä¸ºæ­¢ã€‚è·å¾—é”çš„çº¿ç¨‹ç”¨å®Œåä¸€å®šè¦é‡Šæ”¾é”ï¼Œå¦åˆ™é‚£äº›è‹¦è‹¦ç­‰å¾…é”çš„çº¿ç¨‹å°†æ°¸è¿œç­‰å¾…ä¸‹å»ï¼Œæˆä¸ºæ­»çº¿ç¨‹ã€‚æ‰€ä»¥æˆ‘ä»¬ç”¨`try...finally`æ¥ç¡®ä¿é”ä¸€å®šä¼šè¢«é‡Šæ”¾ã€‚"
>
>   é”çš„ä½œç”¨æ˜¯ç¡®ä¿æŸæ®µå…³é”®ä»£ç åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹ä»å¤´åˆ°å°¾å®Œæ•´åœ°æ‰§è¡Œï¼Œåå¤„å½“ç„¶ä¹Ÿå¾ˆå¤šï¼Œé¦–å…ˆæ˜¯é˜»æ­¢äº†å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼ŒåŒ…å«é”çš„æŸæ®µä»£ç å®é™…ä¸Šåªèƒ½ä»¥å•çº¿ç¨‹æ¨¡å¼æ‰§è¡Œï¼Œæ•ˆç‡å°±å¤§å¤§åœ°ä¸‹é™äº†ã€‚å…¶æ¬¡ï¼Œç”±äºå¯ä»¥å­˜åœ¨å¤šä¸ªé”ï¼Œä¸åŒçš„çº¿ç¨‹æŒæœ‰ä¸åŒçš„é”ï¼Œå¹¶è¯•å›¾è·å–å¯¹æ–¹æŒæœ‰çš„é”æ—¶ï¼Œå¯èƒ½ä¼šé€ æˆ**æ­»é”**ï¼Œå¯¼è‡´å¤šä¸ªçº¿ç¨‹å…¨éƒ¨æŒ‚èµ·ï¼Œæ—¢ä¸èƒ½æ‰§è¡Œï¼Œä¹Ÿæ— æ³•ç»“æŸï¼Œåªèƒ½é æ“ä½œç³»ç»Ÿå¼ºåˆ¶ç»ˆæ­¢ã€‚

- æ–¹æ¡ˆ1: try-finally æ¨¡å¼

```python
import threading, time
lock = threading.Lock()

def do_something(i):
    lock.acquire()
    try:
        print(f"Start doing {i}")
        time.sleep(2)
        print(f"End doing {i}")
    finally:
        lock.release()
    return True

def main():
    threads = []
    for i in range(10):
        this_threading = threading.Thread(target=do_something, args=(i, ))
        # è°ƒç”¨`start()`å¼€å§‹æ‰§è¡Œ
        this_threading.start()
        threads.append(this_threading)

    print("___ä¸»çº¿ç¨‹å¼€å§‹ğŸ”›___")

    # è°ƒç”¨`thread.join()`çš„ä½œç”¨æ˜¯ç¡®ä¿å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åæ‰èƒ½æ‰§è¡Œä¸‹ä¸€ä¸ªçº¿ç¨‹
    for thread in threads:
        thread.join()

    print("___ä¸»çº¿ç¨‹ç»“æŸğŸ”š___")

if __name__ == '__main__':
    main()
```

- æ–¹æ¡ˆ2: withæ¨¡å¼ **æ¨è**

```python
import threading, time
lock = threading.Lock()

def do_something(i):
    with lock:
        print(f"Start doing {i}")
        time.sleep(2)
        print(f"End doing {i}")
    return True

def main():
    threads = []
    for i in range(10):
        this_threading = threading.Thread(target=do_something, args=(i, ))
        # è°ƒç”¨`start()`å¼€å§‹æ‰§è¡Œ
        this_threading.start()
        threads.append(this_threading)

    print("___ä¸»çº¿ç¨‹å¼€å§‹ğŸ”›___")

    # è°ƒç”¨`thread.join()`çš„ä½œç”¨æ˜¯ç¡®ä¿å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•åæ‰èƒ½æ‰§è¡Œä¸‹ä¸€ä¸ªçº¿ç¨‹
    for thread in threads:
        thread.join()

    print("___ä¸»çº¿ç¨‹ç»“æŸğŸ”š___")

if __name__ == '__main__':
    main()
```

## çº¿ç¨‹æ± å’Œè¿›ç¨‹æ±  For `Python3.2+`

>   ä»`Python3.2`å¼€å§‹ï¼Œæ ‡å‡†åº“ä¸ºæˆ‘ä»¬æä¾›äº†`concurrent.futures`æ¨¡å—ï¼Œå®ƒæä¾›äº†`ThreadPoolExecutor`å’Œ`ProcessPoolExecutor`ä¸¤ä¸ªç±»ï¼Œå®ç°äº†å¯¹`threading`å’Œ`multiprocessing`çš„è¿›ä¸€æ­¥æŠ½è±¡

çº¿ç¨‹æ± ä½œç”¨:

- æå‡æ€§èƒ½: å› ä¸ºå‡å»äº†å¤§é‡æ–°å»º, ç»ˆæ­¢çº¿ç¨‹çš„å¼€é”€, é‡ç”¨äº†çº¿ç¨‹èµ„æº
- é€‚ç”¨åœºæ™¯: ä½¿ç”¨å¤„ç†çªå‘å¤§é‡è¯·æ±‚æˆ–è€…éœ€è¦å¤§é‡çº¿ç¨‹å®Œæˆä»»åŠ¡, å®é™…å¤„ç†æ—¶é—´è¾ƒçŸ­
- é˜²å¾¡åŠŸèƒ½: èƒ½æœ‰æ•ˆé¿å…ç³»ç»Ÿå› ä¸ºåˆ›å»ºçº¿ç¨‹è¿‡å¤š,è€Œå¯¼è‡´ç³»ç»Ÿè´Ÿè·è¿‡å¤§å“åº”å˜æ…¢ç­‰é—®é¢˜
- ä»£ç ä¼˜åŠ¿: è¯­æ³•æ¯”è‡ªå·±æ–°å»ºçº¿ç¨‹æ‰§è¡Œçº¿ç¨‹æ›´åŠ ç®€æ´
- å¯ä»¥å¸®æˆ‘ä»¬**è‡ªåŠ¨è°ƒåº¦çº¿ç¨‹**
- ä¸»çº¿ç¨‹å¯ä»¥è·å–æŸä¸€ä¸ªçº¿ç¨‹ï¼ˆæˆ–è€…ä»»åŠ¡çš„ï¼‰çš„çŠ¶æ€ï¼Œä»¥åŠè¿”å›å€¼ã€‚
- å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆçš„æ—¶å€™ï¼Œä¸»çº¿ç¨‹èƒ½å¤Ÿç«‹å³çŸ¥é“ã€‚
- è®©å¤šçº¿ç¨‹å’Œå¤šè¿›ç¨‹çš„ç¼–ç æ¥å£ä¸€è‡´ã€‚

### 1. ThreadPoolExecutor

- ç¬¬ä¸€ç§, ä½¿ç”¨`map`

```python
from concurrent.futures import ThreadPoolExecutor
with ThreadPoolExecutor() as pool:
    # mapå…¥å‚ä¸ç»“æœé¡ºåºæ˜¯ä¸€è‡´çš„
    results = pool.map(func, agr_list)
    for result in results:
        ...
```

- ç¬¬äºŒç§, ä½¿ç”¨`submit`

```python
from concurrent.futures import ThreadPoolExecutor, as_completed
with ThreadPoolExecutor() as pool:
    futures = [pool.submit(func, agr) for agr in agr_list]
    # 1. ä¸ç”¨as_completed, é¡ºåºæ˜¯å›ºå®šçš„
    for future in futures:
        result = future.result()
        
    # 2. ä½¿ç”¨as_completed
    # as_completedç‰¹ç‚¹: é¡ºåºæ˜¯ä¸å›ºå®šçš„
    for future in as_completed(futures):
        result = future.result()
```

## å¤šè¿›ç¨‹(multiprocessing)

ä¼˜ç‚¹: å¯ä»¥åˆ©ç”¨å¤šæ ¸CPUå¹¶è¡Œè¿ç®—
ç¼ºç‚¹: å ç”¨èµ„æºå¤š, å¯å¯åŠ¨æ•°ç›®æ¯”çº¿ç¨‹å°‘
é€‚ç”¨äº: CPUå¯†é›†å‹è®¡ç®—

## æ€»ç»“: 

![multipress_tips](https://cdn.jsdelivr.net/gh/ihatebeans/images@main/img/multipress_tips.jpg)

## å¤šåç¨‹(*Coroutine*)

**æ ¸å¿ƒåŸç†**:

- ç”¨ä¸€ä¸ªè¶…çº§å¾ªç¯(while True)
- é…åˆIOå¤šè·¯å¤ç”¨åŸç†(IOæ—¶CPUå¯ä»¥å¹²å…¶ä»–äº‹æƒ…)

<img src="https://cdn.jsdelivr.net/gh/ihatebeans/images@main/img/image-20210912145850029.png" style="zoom:33%;" />

å­ç¨‹åºè°ƒç”¨æ˜¯é€šè¿‡æ ˆå®ç°çš„ï¼Œä¸€ä¸ªçº¿ç¨‹å°±æ˜¯æ‰§è¡Œä¸€ä¸ªå­ç¨‹åºã€‚
å­ç¨‹åºè°ƒç”¨æ€»æ˜¯ä¸€ä¸ªå…¥å£ï¼Œä¸€æ¬¡è¿”å›ï¼Œè°ƒç”¨é¡ºåºæ˜¯æ˜ç¡®çš„ã€‚è€Œåç¨‹çš„è°ƒç”¨å’Œå­ç¨‹åºä¸åŒã€‚
åç¨‹çœ‹ä¸Šå»ä¹Ÿæ˜¯å­ç¨‹åºï¼Œä½†æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œ**åœ¨å­ç¨‹åºå†…éƒ¨å¯ä¸­æ–­**ï¼Œç„¶åè½¬è€Œæ‰§è¡Œåˆ«çš„å­ç¨‹åºï¼Œåœ¨é€‚å½“çš„æ—¶å€™å†è¿”å›æ¥æ¥ç€æ‰§è¡Œã€‚

ä¼˜ç‚¹: å†…å­˜å¼€é”€æœ€å°‘, å¯åŠ¨åç¨‹æ•°é‡æœ€å¤š
ç¼ºç‚¹: æ”¯æŒçš„åº“æœ‰é™, æ¯”å¦‚:aiohttp, ä»£ç å®ç°å¤æ‚
é€‚ç”¨äº: IOå¯†é›†å‹è®¡ç®—, éœ€è¦è¶…å¤šä»»åŠ¡è¿è¡Œ, ä½†éœ€è¦æœ‰ç°æˆåº“æ”¯æŒçš„åœºæ™¯

```python
import asyncio

# è·å–äº‹ä»¶å¾ªç¯ è‡³å°Šå¾ªç¯ :)
loop = asyncio.get_event_loop()

# å®šä¹‰åç¨‹
async def myfunc(url):
    # get_urlé‡Œé¢æ˜¯IOå¯†é›†å‹è®¡ç®—
    await get_url(url)
    
# åˆ›å»ºtaskåˆ—è¡¨
tasks = [loop.create_task(myfunc(url) for url in urls)]

# æ‰§è¡Œçˆ¬è™«äº‹ä»¶åˆ—è¡¨
loop.run_util_complete(asyncio.wait(tasks))
  
```

### ä½¿ç”¨ä¿¡å·é‡(Semaphore)æ§åˆ¶åç¨‹å¹¶å‘åº¦

ä¿¡å·é‡æ˜¯ä¸€ä¸ªåŒæ­¥å¯¹è±¡, ç”¨äºåŒ…åƒ0åˆ°æœ€å¤§å€¼ä¹‹é—´çš„ä¸€ä¸ªæŠ€æœ¯å€¼.ç­‰å¾…-1, é‡Šæ”¾+1, å¤§äº0ä¸ºsignaledçŠ¶æ€, ç­‰äº0ä¸ºnosignaledçŠ¶æ€

ç¬¬ä¸€ç§, ä½¿ç”¨with **æ¨è**

```python
sem = asyncio.Semaphore(10)
asyncio with sem:
    ...
```

ç¬¬äºŒç§, ä½¿ç”¨try...finally

```python
sem = asyncio.Semaphore(10)
await sem.aquire()
try:
    ...
finally:
    sem.release()
```

## æ ¹æ®ä»»åŠ¡é€‰æ‹©å¯¹åº”æŠ€æœ¯

![image-20210912135624079](https://cdn.jsdelivr.net/gh/ihatebeans/images@main/img/image-20210912135624079.png)




#### å‚è€ƒé“¾æ¥:

- å»–é›ªå³°å®˜æ–¹ç½‘ç«™: https://www.liaoxuefeng.com/wiki/1016959663602400/1017968846697824
- ç®€ä¹¦: https://www.jianshu.com/p/b9b3d66aa0be
- Bç«™: https://www.bilibili.com/video/BV1bK411A7tV?p=2&spm_id_from=pageDriver
- ç†è§£GIL: http://www.dabeaz.com/python/UnderstandingGIL.pdf

